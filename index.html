let currentTabIndex = 0;
const tabs = [{
    url: 'helios://start',
    content: `
        <h23>Helios</h23>
        <h21>𝚖𝚊𝚍𝚎 𝚋𝚢 𝚍𝚒𝚗𝚐𝚞𝚜𝚌𝚑𝚊𝚗!</h21>
        <div class="search-bar">
          <div class="search-container">
  <div class="search-engine-dropdown" onclick="toggleDropdown(${currentTabIndex})">
    <img src="https://www.google.com/favicon.ico" alt="Google" id="selected-engine-${currentTabIndex}">
  </div>
  <div class="dropdown-content" id="engineDropdown-${currentTabIndex}">
    <div class="status-message" id="statusMessage-${currentTabIndex}">Searching with Google</div>
    <a href="#" onclick="selectEngine('https://4get.ca/favicon.ico', '4get', ${currentTabIndex})" data-engine="4get">
      <img src="https://4get.ca/favicon.ico" alt="4get"> Search with 4get
    </a>
    <a href="#" onclick="selectEngine('https://www.google.com/favicon.ico', 'Google', ${currentTabIndex})" data-engine="Google">
      <img src="https://www.google.com/favicon.ico" alt="Google"> Search with Google
    </a>
    <a href="#" onclick="selectEngine('https://www.bing.com/favicon.ico', 'Bing', ${currentTabIndex})" data-engine="Bing">
      <img src="https://www.bing.com/favicon.ico" alt="Bing"> Search with Bing
    </a>
    <a href="#" onclick="selectEngine('https://duckduckgo.com/favicon.ico', 'DuckDuckGo', ${currentTabIndex})" data-engine="DuckDuckGo">
      <img src="https://duckduckgo.com/favicon.ico" alt="DuckDuckGo"> Search with DuckDuckGo
    </a>
  </div>
</div>
            <input type="text" placeholder="Search the web or type a URL" id="search-input-${currentTabIndex}">
            <i class="fas fa-search search-icon"></i>`
}];

const trustedSchemes = ['helios://', 'https://', 'data://', 'ws://'];

document.getElementById('add-tab').addEventListener('click', function () {
    const newTabIndex = tabs.length;
    const newTab = document.createElement('div');
    newTab.className = 'tab';
    newTab.innerHTML = `<span class="tab-name">New Tab</span><i class="fas fa-times close-btn"></i>`;
    document.querySelector('.top-bar').insertBefore(newTab, this);

    const newContent = document.createElement('div');
    newContent.className = 'content tab-content';
    newContent.innerHTML = tabs[0].content.replace(/\${currentTabIndex}/g, newTabIndex);
    document.body.appendChild(newContent);

    tabs.push({ url: 'helios://start', content: newContent.innerHTML });

    updateActiveTab(newTab, newContent, newTabIndex);
    addCloseButtonFunctionality(newTab);
    addTabClickListener(newTab, newContent, newTabIndex);
});

document.querySelectorAll('.tab').forEach((tab, index) => {
    addCloseButtonFunctionality(tab);
    addTabClickListener(tab, document.querySelectorAll('.tab-content')[index], index);
});

function addCloseButtonFunctionality(tab) {
    tab.querySelector('.close-btn').addEventListener('click', function () {
        const index = Array.from(document.querySelectorAll('.tab')).indexOf(tab);
        tab.remove();
        document.querySelectorAll('.tab-content')[index].remove();
        tabs.splice(index, 1);
        if (index === currentTabIndex) {
            const newActiveTab = document.querySelectorAll('.tab')[index] || document.querySelectorAll('.tab')[index - 1];
            if (newActiveTab) {
                newActiveTab.click();
            }
        }
    });
}

function addTabClickListener(tab, content, index) {
    tab.addEventListener('click', function () {
        updateActiveTab(tab, content, index);
    });
}

function updateActiveTab(tab, content, index) {
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });

    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });

    tab.classList.add('active');
    content.classList.add('active');

    currentTabIndex = index;
    const url = tabs[index].url;
    document.getElementById('url-bar').value = url;

    updateTabContent(url, content, tab);
    updateLockIcon(url);
    updateSpecialDivs(url);
}

function updateTabContent(url, content, tab) {
    localStorage.setItem(`tab_${currentTabIndex}`, url);
    sessionStorage.setItem(`tab_${currentTabIndex}`, url);
  
    if (url === 'helios://start') {
        content.innerHTML = `
        <h23>Helios</h23>
        <h21>𝚖𝚊𝚍𝚎 𝚋𝚢 𝚍𝚒𝚗𝚐𝚞𝚜𝚌𝚑𝚊𝚗!</h21>
        <div class="search-bar">
          <div class="search-container">
  <div class="search-engine-dropdown" onclick="toggleDropdown(${currentTabIndex})">
    <img src="https://www.google.com/favicon.ico" alt="Google" id="selected-engine-${currentTabIndex}">
  </div>
  <div class="dropdown-content" id="engineDropdown-${currentTabIndex}">
    <div class="status-message" id="statusMessage-${currentTabIndex}">Searching with Google</div>
    <a href="#" onclick="selectEngine('https://4get.ca/favicon.ico', '4get', ${currentTabIndex})" data-engine="4get">
      <img src="https://4get.ca/favicon.ico" alt="4get"> Search with 4get
    </a>
    <a href="#" onclick="selectEngine('https://www.google.com/favicon.ico', 'Google', ${currentTabIndex})" data-engine="Google">
      <img src="https://www.google.com/favicon.ico" alt="Google"> Search with Google
    </a>
    <a href="#" onclick="selectEngine('https://www.bing.com/favicon.ico', 'Bing', ${currentTabIndex})" data-engine="Bing">
      <img src="https://www.bing.com/favicon.ico" alt="Bing"> Search with Bing
    </a>
    <a href="#" onclick="selectEngine('https://duckduckgo.com/favicon.ico', 'DuckDuckGo', ${currentTabIndex})" data-engine="DuckDuckGo">
      <img src="https://duckduckgo.com/favicon.ico" alt="DuckDuckGo"> Search with DuckDuckGo
    </a>
  </div>
</div>
            <input type="text" placeholder="Search the web or type a URL" id="search-input-${currentTabIndex}">
            <i class="fas fa-search search-icon"></i>`;
        
        tab.querySelector('.tab-name').textContent = 'New Tab';
        tabs[currentTabIndex].content = content.innerHTML;
        tabs[currentTabIndex].url = url;

        document.getElementById(`search-input-${currentTabIndex}`).addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const enteredUrl = this.value;
                if (enteredUrl) {
                    updateTabContent(enteredUrl, content, tab);
                }
            }
        });

    } else if (url === 'helios://settings') {
        content.innerHTML = `
        <h20>Helios Settings</h20><br>
        <div class="settings-grid">
            <div class="settings-block">   <h24>&nbspHistory&nbsp</h24>             <button id="clear-history-${currentTabIndex}" class="clear-button">Clear History</button></div>
            <div class="settings-block"><h24>Cloaking</h24>    <button class="cloak-button" onclick="openInAboutBlank(${currentTabIndex})">Open in about:blank</button>
    <button class="cloak-button" onclick="openInBlob(${currentTabIndex})">Open in blob:</button></div>
            <div class="settings-block">Block 3 Info</div>
            <div class="settings-block">Block 4 Info</div>
            <div class="settings-block">Block 5 Info</div>
            <div class="settings-block">Block 6 Info</div>
            <div class="clear-block">

            </div>
        </div>
        <div id="clear-message-${currentTabIndex}" class="clear-message"></div>
        `;
        tab.querySelector('.tab-name').textContent = 'Settings';
        tabs[currentTabIndex].content = content.innerHTML;
        tabs[currentTabIndex].url = url;

        document.getElementById(`clear-history-${currentTabIndex}`).addEventListener('click', function() {
            localStorage.removeItem(`tab_${currentTabIndex}`);
            sessionStorage.removeItem(`tab_${currentTabIndex}`);
            const messageDiv = document.getElementById(`clear-message-${currentTabIndex}`);
            messageDiv.textContent = 'History has been cleared for this tab!';
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        });
    } else {
        fetchExternalContent(url, content, currentTabIndex);
    }

    document.getElementById('url-bar').value = url;
    
    tabs[currentTabIndex].content = content.innerHTML;
    tabs[currentTabIndex].url = url;

    updateLockIcon(url);
    updateSpecialDivs(url);
}

document.addEventListener('DOMContentLoaded', () => {
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('tab_')) {
            const url = localStorage.getItem(key);
            // Logic to create a new tab with this URL
        }
    }
});

document.addEventListener('DOMContentLoaded', () => {
    const urlBar = document.getElementById('url-bar');
    const content = document.getElementById('content');

    urlBar.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            const url = urlBar.value;
            fetchExternalContent(url, content, currentTabIndex);
        }
    });
});

async function fetchExternalContent(url, content, tabIndex) {
    const proxies = [
        `https://api.codetabs.com/v1/proxy?quest=${url}`,
        `https://api.codetabs.com/v1/tmp/?quest=${url}`,
        `https://corsproxy.io/?${url}`,
        `https://api.allorigins.win/raw?url=${url}`
    ];

    const timeout = 10000;

    async function fetchWithProxy(proxy) {
        return new Promise((resolve, reject) => {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);

            fetch(proxy, { signal: controller.signal })
                .then(response => {
                    clearTimeout(id);
                    if (!response.ok) {
                        reject(`Failed to fetch content from ${proxy}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(resolve)
                .catch(reject);
        });
    }

    let htmlText;
    for (const proxy of proxies) {
        try {
            htmlText = await fetchWithProxy(proxy);
            break;
        } catch (error) {
            console.error(`Error with proxy ${proxy}: ${error}`);
        }
    }

    if (!htmlText) {
        console.error('Failed to fetch content from all proxies');
        return;
    }
  
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlText, 'text/html');
    const title = doc.title;
    const tab = document.querySelectorAll('.tab')[tabIndex];
    if (tab) {
        tab.querySelector('.tab-name').textContent = title || 'Untitled';
    }

    async function fetchAndInjectResources(html, tabIndex) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const resources = [];
        const cssLinks = doc.querySelectorAll('link[rel="stylesheet"]');
        const jsScripts = doc.querySelectorAll('script[src]');
        const images = doc.querySelectorAll('img');

        cssLinks.forEach(link => resources.push(link.href));
        jsScripts.forEach(script => resources.push(script.src));
        images.forEach(img => resources.push(img.src));

        const fetchResource = async (url) => {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch resource ${url}`);
                }
                return await response.text();
            } catch (error) {
                console.error(error);
                return '';
            }
        };

        const promises = resources.map(fetchResource);
        const results = await Promise.all(promises);

        const shadowContainer = document.createElement('div');
        shadowContainer.style.position = 'relative';
        shadowContainer.style.width = (content.clientWidth - 0) + 'px';
        shadowContainer.style.height = (content.clientHeight + 100) + 'px';
        shadowContainer.style.overflow = 'auto';
        shadowContainer.style.border = 'none';

        const shadowRoot = shadowContainer.attachShadow({ mode: 'open' });
        const defaultStyle = document.createElement('style');
        defaultStyle.textContent = `
            :host {
                all: initial;
                background-color: #fff !important;
            }
        `;
        shadowRoot.appendChild(defaultStyle);
        shadowRoot.innerHTML += html;

        const fixRelativeURLs = (baseUrl) => {
            const anchors = shadowRoot.querySelectorAll('a[href], link[href], script[src], img[src]');

            anchors.forEach(anchor => {
                const url = new URL(anchor.getAttribute('href') || anchor.getAttribute('src'), baseUrl);
                if (anchor.hasAttribute('href')) {
                    anchor.setAttribute('href', url.href);
                } else if (anchor.hasAttribute('src')) {
                    anchor.setAttribute('src', url.href);
                }
            });
        };

        results.forEach((result, index) => {
            const url = resources[index];
            if (url.endsWith('.css')) {
                const style = document.createElement('style');
                style.textContent = result;
                shadowRoot.appendChild(style);
            } else if (url.endsWith('.js')) {
                const script = document.createElement('script');
                script.textContent = result;
                shadowRoot.appendChild(script);
            }
        });

        shadowRoot.querySelectorAll('style').forEach(style => {
            style.textContent = `
                :host {
                    all: initial;
                }
                ${style.textContent}
            `;
        });

        const baseUrl = new URL(html.match(/<base href="([^"]+)"/)?.[1] || '', url).href;
        fixRelativeURLs(baseUrl);

        shadowRoot.querySelectorAll('a').forEach(anchor => {
            anchor.addEventListener('click', (event) => {
                event.preventDefault();
                const newUrl = anchor.href;
                updateTabContent(newUrl, content, tab);
            });
        });

        return shadowContainer;
    }

    const newShadowContainer = await fetchAndInjectResources(htmlText, tabIndex);
    content.innerHTML = '';
    content.appendChild(newShadowContainer);

    requestAnimationFrame(() => {
        tabs[tabIndex].content = content.innerHTML;
        tabs[tabIndex].url = url;
    });
}

function updateLockIcon(url) {
    const lockIcon = document.querySelector('.lock-icon');
    const isLocked = trustedSchemes.some(scheme => url.startsWith(scheme));
    if (isLocked) {
        lockIcon.classList.remove('fa-unlock');
        lockIcon.classList.add('fa-lock');
        lockIcon.style.color = '';
    } else {
        lockIcon.classList.remove('fa-lock');
        lockIcon.classList.add('fa-unlock');
        lockIcon.style.color = '#ffff80';
    }
}

function updateSpecialDivs(url) {
    const isHeliosURL = url.startsWith('helios://');
    const officialC = document.querySelector('.official-c');
    const official = document.querySelector('.official');

    if (officialC) {
        officialC.style.backgroundColor = isHeliosURL ? '' : '#52565b';
    }
    if (official) {
        official.style.backgroundColor = isHeliosURL ? '' : '#52565b';
        official.style.color = isHeliosURL ? '' : '#52565b';
    }
}

document.getElementById('url-bar').addEventListener('input', function () {
    const url = this.value;
    tabs[currentTabIndex].url = url;
    updateLockIcon(url);
    updateSpecialDivs(url);
});

document.getElementById('url-bar').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        let url = e.target.value.trim();
        
        const hasValidScheme = trustedSchemes.some(scheme => url.startsWith(scheme));
        
        if (!hasValidScheme) {
            url = 'https://' + url;
        }

        const currentContent = document.querySelectorAll('.tab-content')[currentTabIndex];
        const currentTab = document.querySelectorAll('.tab')[currentTabIndex];

        tabs[currentTabIndex].url = url;
        document.getElementById('url-bar').value = url;
        updateTabContent(url, currentContent, currentTab);
        updateLockIcon(url);
        updateSpecialDivs(url);
    }
});

document.querySelector('.home-button').addEventListener('click', function () {
    changeTabContent('helios://start');
});

document.querySelector('.settings-button').addEventListener('click', function () {
    changeTabContent('helios://settings');
});

function changeTabContent(url) {
    const currentTab = document.querySelectorAll('.tab')[currentTabIndex];
    const currentContent = document.querySelectorAll('.tab-content')[currentTabIndex];

    if (currentTab && currentContent) {
        document.getElementById('url-bar').value = url;

        tabs[currentTabIndex].url = url;
        updateTabContent(url, currentContent, currentTab);

        const event = new KeyboardEvent('keydown', {
            bubbles: true,
            cancelable: true,
            key: 'Enter',
            code: 'Enter'
        });
        document.getElementById('url-bar').dispatchEvent(event);
    }
}

function openInAboutBlank(tabIndex) {
    const html = tabs[tabIndex].content;
    const newWindow = window.open("about:blank");
    newWindow.document.write(html);
    newWindow.document.close();
}

function openInBlob(tabIndex) {
    const html = tabs[tabIndex].content;
    const blob = new Blob([html], { type: 'text/html' });
    const blobURL = URL.createObjectURL(blob);
    window.open(blobURL);
}

function toggleDropdown(tabIndex) {
    var dropdown = document.getElementById(`engineDropdown-${tabIndex}`);
    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    updateDropdownVisibility(tabIndex);
}

function selectEngine(iconSrc, engineName, tabIndex) {
    document.getElementById(`selected-engine-${tabIndex}`).src = iconSrc;
    document.getElementById(`selected-engine-${tabIndex}`).alt = engineName;
    document.getElementById(`statusMessage-${tabIndex}`).textContent = "Searching with " + engineName;
    toggleDropdown(tabIndex);
}

function updateDropdownVisibility(tabIndex) {
    var selectedEngine = document.getElementById(`selected-engine-${tabIndex}`).alt;
    var options = document.querySelectorAll(`#engineDropdown-${tabIndex} a`);
    options.forEach(function(option) {
        if (option.getAttribute("data-engine") === selectedEngine) {
            option.style.display = "none";
        } else {
            option.style.display = "flex";
        }
    });
}

window.onclick = function(event) {
    if (!event.target.matches('.search-engine-dropdown') && !event.target.matches('.search-engine-dropdown img')) {
        var dropdowns = document.querySelectorAll('.dropdown-content');
        dropdowns.forEach(function(dropdown) {
            if (dropdown.style.display === "block") {
                dropdown.style.display = "none";
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    tabs.forEach((tab, index) => {
        document.getElementById(`statusMessage-${index}`).textContent = "Searching with Google";
        updateDropdownVisibility(index);
    });
});
      
      document.getElementById('url-bar').addEventListener('input', function(e) {
    this.value = this.value.toLowerCase();
});
